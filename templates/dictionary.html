{% extends "base.html" %}

{% block content %}
<div class="search-container">
    <div class="search-form">
        <input type="text" id="search-input" placeholder="Enter a word to search...">
        <button id="search-button">Search</button>
    </div>
    <div id="loading" class="loading-indicator" style="display: none;">Searching...</div>
    <div id="results" class="results-area"></div>
    <div id="past-searches">
        <h3>Past Searches</h3>
        <ul id="past-searches-list"></ul>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const loadingIndicator = document.getElementById('loading');
        const resultsArea = document.getElementById('results');
        const pastSearchesList = document.getElementById('past-searches-list');

        let pastSearches = JSON.parse(localStorage.getItem('pastSearches')) || [];
        updatePastSearchesList();

        function showSearchSuggestions() {
            const query = searchInput.value.trim();
            if (!query) return;
            
            loadingIndicator.style.display = 'block';
            resultsArea.innerHTML = '';
            
            fetch(`/search?query=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(data => {
                    loadingIndicator.style.display = 'none';
                    displayResults(data, query);
                })
                .catch(error => {
                    loadingIndicator.style.display = 'none';
                    resultsArea.innerHTML = `<div class="error">Error: ${error.message}</div>`;
                });
        }

        function performSearch() {
            const query = searchInput.value.trim();
            if (!query) return;
            
            showSearchSuggestions();
            
            if (!pastSearches.includes(query)) {
                pastSearches.unshift(query);
                if (pastSearches.length > 5) pastSearches.pop();
                localStorage.setItem('pastSearches', JSON.stringify(pastSearches));
                updatePastSearchesList();
            }
        }

        function displayResults(data, query) {
            resultsArea.innerHTML = '';

            if (data.exact_match) {
                const exactMatch = document.createElement('div');
                exactMatch.className = 'result exact-match';
                exactMatch.innerHTML = `
                    <h3>Exact match found:</h3>
                    <p><strong>${data.exact_match.word}</strong> - ${data.exact_match.meaning}</p>
                `;
                resultsArea.appendChild(exactMatch);
            } else if (data.suggestions && data.suggestions.length > 0) {
                const suggestionsDiv = document.createElement('div');
                suggestionsDiv.className = 'suggestions';
                suggestionsDiv.innerHTML = `<h3>Did you mean:</h3>`;
                
                const suggestionsList = document.createElement('ul');
                data.suggestions.forEach(suggestion => {
                    const item = document.createElement('li');
                    item.innerHTML = `<strong>${suggestion.word}</strong> - ${suggestion.meaning}`;
                    suggestionsList.appendChild(item);
                });
                
                suggestionsDiv.appendChild(suggestionsList);
                resultsArea.appendChild(suggestionsDiv);
            } else {
                resultsArea.innerHTML = `<div class="no-results">No matches found for "${query}".</div>`;
            }
        }

        function updatePastSearchesList() {
            pastSearchesList.innerHTML = '';
            pastSearches.forEach(search => {
                const li = document.createElement('li');
                li.textContent = search;
                li.addEventListener('click', () => {
                    searchInput.value = search;
                    performSearch();
                });
                pastSearchesList.appendChild(li);
            });
        }

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch(); 
            }
        });

        let typingTimer;
        searchInput.addEventListener('input', function() {
            clearTimeout(typingTimer);
            if (searchInput.value.trim().length > 2) {
                typingTimer = setTimeout(showSearchSuggestions, 300);
            }
        });
    });
</script>
{% endblock %}
